<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßπ Limpiar Service Worker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpiador de Service Worker</h1>
        <p>Este script limpiar√° completamente el Service Worker y el cach√© del navegador.</p>
        
        <button onclick="clearServiceWorker()">üßπ Limpiar Service Worker</button>
        <button onclick="checkStatus()">üîç Verificar Estado</button>
        
        <div id="status"></div>
        <div id="instructions" style="margin-top: 20px; text-align: left;">
            <h3>üìã Instrucciones:</h3>
            <ol>
                <li>Haz clic en "üßπ Limpiar Service Worker"</li>
                <li>Espera a que aparezca el mensaje de √©xito</li>
                <li>Cierra esta pesta√±a</li>
                <li>Recarga la aplicaci√≥n principal</li>
            </ol>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function clearServiceWorker() {
            updateStatus('üîÑ Limpiando Service Worker...', 'info');
            
            try {
                // 1. Desregistrar todos los Service Workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('‚úÖ Service Worker desregistrado:', registration.scope);
                    }
                }
                
                // 2. Limpiar todos los caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(
                        cacheNames.map(cacheName => {
                            console.log('üóëÔ∏è Eliminando cache:', cacheName);
                            return caches.delete(cacheName);
                        })
                    );
                }
                
                // 3. Limpiar localStorage de Service Worker
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('sw-') || key.includes('service-worker') || key.includes('cache'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                updateStatus('‚úÖ ¬°Service Worker limpiado exitosamente!<br>üóëÔ∏è Cach√© eliminado<br>üßπ LocalStorage limpiado<br><br>‚úÖ Ahora puedes cerrar esta pesta√±a y recargar la aplicaci√≥n.', 'success');
                
            } catch (error) {
                console.error('‚ùå Error limpiando Service Worker:', error);
                updateStatus('‚ùå Error limpiando Service Worker: ' + error.message, 'error');
            }
        }

        async function checkStatus() {
            updateStatus('üîç Verificando estado del Service Worker...', 'info');
            
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    if (registrations.length === 0) {
                        updateStatus('‚úÖ No hay Service Workers registrados', 'success');
                    } else {
                        updateStatus(`‚ö†Ô∏è ${registrations.length} Service Worker(s) encontrado(s):<br>` + 
                                   registrations.map(r => `- ${r.scope}`).join('<br>'), 'error');
                    }
                } else {
                    updateStatus('‚ÑπÔ∏è Service Worker no soportado en este navegador', 'info');
                }
                
                // Verificar caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length === 0) {
                        updateStatus(updateStatus().innerHTML + '<br>‚úÖ No hay caches almacenados', 'success');
                    } else {
                        updateStatus(updateStatus().innerHTML + `<br>‚ö†Ô∏è ${cacheNames.length} cache(s) encontrado(s)`, 'error');
                    }
                }
                
            } catch (error) {
                updateStatus('‚ùå Error verificando estado: ' + error.message, 'error');
            }
        }

        // Verificar estado al cargar
        window.addEventListener('load', checkStatus);
    </script>
</body>
</html>
